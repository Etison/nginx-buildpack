#!/usr/bin/env bash

echo 'buildpack=nginx at=nginx-config'

# Evaluate config to get $PORT
erb config/nginx.conf.erb > config/nginx.conf

# Start log redirection.
(
	# Initialize log directory.
	mkdir -p logs/nginx
	touch logs/nginx/access.log logs/nginx/error.log

	# Redirect NGINX logs to stdout.
	echo 'buildpack=nginx at=logs-initialized'
	tail -qF -n 0 logs/nginx/*.log
) &


# Start NGINX
# We expect nginx to run in foreground.
echo 'buildpack=nginx at=nginx-start'
bin/nginx -p . -c config/nginx.conf
echo "buildpack=nginx at=exit"

exit 1
